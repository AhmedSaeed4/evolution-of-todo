# Implementation Plan: MCP Agent Integration

**Branch**: `009-agents-mcp` | **Date**: 2026-01-13 | **Spec**: [specs/009-agents-mcp/spec.md](specs/009-agents-mcp/spec.md)
**Input**: Feature specification from `/specs/009-agents-mcp/spec.md`

**Note**: This plan is generated by `/sp.plan` command based on research and design phases.

## Summary

Build a dual-agent system with Urdu language specialization, integrate MCP tools for CRUD operations, and create a frontend chatbot interface. The system enables natural language task management through AI agents while maintaining strict user isolation and security.

**Three-phase approach**:
1. **Agent Foundation**: Dual-agent system with Urdu routing
2. **MCP Integration**: 7 CRUD tools with user isolation
3. **Frontend UI**: Chatbot interface with agent attribution

## Technical Context

**Language/Version**: Python 3.13+ (Backend), TypeScript 5.x (Frontend)
**Primary Dependencies**:
- Backend: FastAPI 0.128.0, SQLModel 0.0.31, OpenAI Agents SDK, MCP SDK
- Frontend: Next.js 16.1.1, React 19.2.3, Framer Motion 12.23.26
- Database: Neon Serverless PostgreSQL
- Authentication: Better Auth v1.4.9 with JWT

**Storage**: Neon PostgreSQL (existing) + new tables for agent sessions
**Testing**: pytest (backend), Jest (frontend), MCP tool validation
**Target Platform**: Linux server (FastAPI), Web browser (Next.js)
**Project Type**: Web application (backend + frontend)
**Performance Goals**:
- Chat response: <2s p95
- MCP tool execution: <500ms p95
- Database queries: <200ms p95

**Constraints**:
- Zero server-side session state (Constitution III)
- User isolation at query level (Constitution V)
- MCP-first architecture (Constitution II)
- Single-file backend entry point (FR-001)

**Scale/Scope**:
- Single user isolation per request
- 7 MCP tools for task operations
- Dual-agent coordination
- Real-time chat interface

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Evolution of Todo Constitution v1.1.0 Compliance:**

- ✅ **I. Universal Logic Decoupling**: Business logic in TaskService, decoupled from agent layer
- ✅ **II. AI-Native Interoperability**: MCP tools defined with strict Pydantic typing
- ✅ **III. Strict Statelessness**: MCP server created per request, no persistent sessions
- ✅ **IV. Event-Driven Decoupling**: Async operations throughout, ready for future event streams
- ✅ **V. Zero-Trust Multi-Tenancy**: All tools require user_id, all queries scoped
- ✅ **VI. Technology Stack**: Python 3.13+, FastAPI, SQLModel, OpenAI Agents SDK (authorized)
- ✅ **VII. Security**: JWT validation, Pydantic input validation, environment-based secrets
- ✅ **VIII. Observability**: Structured logging, metrics, audit trail via existing patterns

**All gates pass. No violations requiring justification.**

## Project Structure

### Documentation (this feature)

```text
specs/009-agents-mcp/
├── plan.md              # This file - implementation roadmap
├── research.md          # Phase 0 - technical research & decisions
├── data-model.md        # Phase 1 - entity definitions & relationships
├── quickstart.md        # Phase 1 - setup guide & testing
├── contracts/           # Phase 1 - API & tool contracts
│   ├── openapi.yaml     # REST API specification
│   └── mcp-tools.md     # MCP tool signatures
└── tasks.md             # Phase 2 - detailed tasks (to be created by /sp.tasks)
```

### Source Code (repository root)

```text
# Web application structure (backend + frontend)
phase-3/backend/
├── src/backend/
│   ├── main.py                    # Updated: + /api/chat endpoint, agent integration
│   ├── config.py                  # Existing: environment configuration
│   ├── database.py                # Existing: Neon PostgreSQL connection
│   ├── models/
│   │   └── task.py                # Existing: Task entity
│   ├── schemas/
│   │   └── task.py                # Existing: Pydantic schemas
│   ├── routers/
│   │   └── tasks.py               # Existing: 7 RESTful endpoints
│   ├── services/
│   │   └── task_service.py        # Existing: Business logic layer
│   ├── auth/
│   │   └── jwt.py                 # Existing: JWT validation
│   ├── agents.py                  # NEW: Dual-agent system (orchestrator + Urdu)
│   └── task_serves_mcp_tools.py  # NEW: 7 MCP tools with user isolation
└── pyproject.toml                 # Updated: + openai-agents, mcp dependencies

phase-3/frontend/
├── src/
│   ├── app/
│   │   ├── chatbot/
│   │   │   └── page.tsx          # NEW: Chatbot interface
│   │   ├── (dashboard)/          # Existing: Protected routes
│   │   ├── (auth)/               # Existing: Authentication pages
│   │   ├── api/auth/[...all]/    # Existing: Better Auth handler
│   │   └── layout.tsx            # Existing: Root layout
│   ├── components/
│   │   ├── ui/                   # Existing: Reusable components
│   │   └── tasks/                # Existing: Task components
│   ├── contexts/
│   │   └── AuthContext.tsx       # Existing: Auth state
│   ├── hooks/
│   │   ├── useAuth.ts            # Existing: Auth hook
│   │   └── useTasks.ts           # Existing: Task operations
│   ├── lib/
│   │   ├── auth.ts               # Existing: Auth utilities
│   │   ├── api-client.ts         # Existing: API wrapper
│   │   └── api.ts                # Existing: Task API methods
│   └── types/
│       └── index.ts              # Existing: TypeScript definitions
└── package.json                   # No new dependencies needed
```

**Structure Decision**: Web application structure (Option 2) - maintains existing phase-3 architecture while adding agent capabilities. All new files integrate seamlessly with existing infrastructure.

## Complexity Tracking

> **Filled**: No Constitution violations requiring justification. All requirements met within existing authorized stack.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A - All requirements met | N/A | N/A |

## Implementation Phases

### Phase 0: Research & Clarification ✅ COMPLETE
**Duration**: 1 hour
**Output**: `research.md`

**Completed Research**:
- ✅ OpenAI Agents SDK integration with FastAPI
- ✅ MCP server lifecycle management (per-request creation)
- ✅ Urdu language detection (Unicode + keyword matching)
- ✅ MCP tool user isolation (user_id parameter)
- ✅ Frontend chatbot integration (existing apiClient)
- ✅ Agent attribution display (API response metadata)
- ✅ Structured response format (`{success, data/error}`)
- ✅ FastAPI + agent integration (`/api/chat` endpoint)

**Key Decisions**:
- Use Xiaomi mimo-v2-flash via AsyncOpenAI
- Dynamic MCP server per request with try/finally cleanup
- Unicode range detection for Urdu content
- All tools require user_id parameter
- Reuse existing JWT auth and API client

### Phase 1: Design & Contracts ✅ COMPLETE
**Duration**: 2 hours
**Outputs**: `data-model.md`, `contracts/`, `quickstart.md`

**Completed Design**:
- ✅ **Data Model**: 4 entities (Agent, ChatSession, ChatMessage, Task)
- ✅ **Entity Relationships**: Complete ER diagram with foreign keys
- ✅ **Validation Rules**: Pydantic schemas for all inputs
- ✅ **API Contracts**: OpenAPI spec for 7 endpoints
- ✅ **MCP Tools Contract**: 7 tools with signatures and examples
- ✅ **Quickstart Guide**: 5-minute setup with testing workflows

**Design Highlights**:
- **User Isolation**: All queries scoped to user_id
- **Statelessness**: No server-side session storage
- **Type Safety**: Strict typing throughout stack
- **Security**: JWT validation, input validation, audit trail

### Phase 2: Task Generation ⏳ PENDING
**Duration**: 3 hours
**Output**: `tasks.md` (created by `/sp.tasks`)

**Planned Tasks**:
1. **Backend Tasks** (10 tasks)
   - Install OpenAI Agents SDK and MCP dependencies
   - Create `agents.py` with dual-agent system
   - Create `task_serves_mcp_tools.py` with 7 tools
   - Update `main.py` with `/api/chat` endpoint
   - Add database migrations for new tables
   - Implement JWT integration for agents
   - Test all MCP tools with user isolation
   - Validate agent routing logic
   - Performance testing
   - Security validation

2. **Frontend Tasks** (5 tasks)
   - Create `/chatbot` page with message interface
   - Implement agent attribution display
   - Add loading states and error handling
   - Test with various message types
   - Validate Urdu language support

3. **Integration Tasks** (3 tasks)
   - End-to-end workflow testing
   - User isolation validation
   - Performance validation

### Phase 3: Implementation ⏳ AFTER /sp.tasks
**Duration**: 4-6 hours
**Output**: Working dual-agent system with chatbot

**Implementation Approach**:
- Follow quickstart.md for step-by-step setup
- Use existing infrastructure (TaskService, JWT auth, API client)
- Test each phase independently
- Validate Constitution compliance at each step

## Success Criteria

### Phase 1 Complete When:
- ✅ All technical unknowns resolved (research.md)
- ✅ Data model defined (data-model.md)
- ✅ API contracts specified (openapi.yaml, mcp-tools.md)
- ✅ Quickstart guide created (quickstart.md)
- ✅ Constitution compliance verified

### Phase 2 Complete When:
- ✅ All tasks defined and prioritized
- ✅ User stories mapped to tasks
- ✅ Dependencies identified
- ✅ Acceptance criteria included

### Phase 3 Complete When:
- ✅ Dual-agent system operational
- ✅ 7 MCP tools working with user isolation
- ✅ Chatbot interface functional
- ✅ Urdu language routing working
- ✅ All user stories independently testable

## Dependencies & Prerequisites

### Backend Prerequisites
- ✅ **Existing**: FastAPI app, JWT auth, TaskService, Neon DB
- ❌ **Missing**: OpenAI Agents SDK, MCP SDK
- ❌ **Missing**: Agent orchestration logic
- ❌ **Missing**: MCP tools file

### Frontend Prerequisites
- ✅ **Existing**: Next.js app, AuthContext, API client, UI components
- ❌ **Missing**: Chatbot page and components

### External Dependencies
- ✅ **Xiaomi API**: Requires `XIAOMI_API_KEY` environment variable
- ✅ **Neon DB**: Already configured in phase-2
- ✅ **Better Auth**: Already configured in phase-2

## Risk Mitigation

### Technical Risks
| Risk | Impact | Mitigation | Test |
|------|--------|------------|------|
| Agent coordination complexity | Medium | Clear routing logic + fallback | Sample queries |
| MCP resource leaks | High | Try/finally cleanup pattern | Load testing |
| Urdu detection accuracy | Low | Unicode + keyword + manual override | Diverse test cases |
| Performance degradation | Medium | Async operations + indexing | p95 latency tests |

### Security Risks
| Risk | Impact | Mitigation | Validation |
|------|--------|------------|------------|
| Cross-user data access | Critical | user_id in all tools + queries | Isolation tests |
| JWT validation bypass | Critical | Validate on every request | Token tampering tests |
| Input injection attacks | High | Pydantic validation + parameterized queries | Fuzzing tests |

### Operational Risks
| Risk | Impact | Mitigation | Monitoring |
|------|--------|------------|------------|
| Agent response latency | Medium | Async operations + caching | p95 metrics |
| Tool execution failures | Medium | Structured error handling | Error rate tracking |
| System complexity | Low | Clear documentation + quickstart | Developer testing |

## Next Steps

### Immediate Actions
1. **Review this plan** and approve for implementation
2. **Run `/sp.tasks`** to generate detailed task list
3. **Set up environment** with new dependencies
4. **Begin Phase 3 implementation** following quickstart guide

### After Plan Approval
1. **Create tasks.md** via `/sp.tasks` command
2. **Start with backend** (Phase 1: agents.py + MCP tools)
3. **Add frontend** (Phase 2: chatbot page)
4. **Test end-to-end** (Phase 3: validation)

### Success Validation
- [ ] All user stories independently testable
- [ ] Constitution compliance verified
- [ ] Performance targets met
- [ ] Security validation passed
- [ ] Quickstart guide works as documented

---

**Plan Status**: ✅ **READY FOR IMPLEMENTATION**

All research complete, design finalized, contracts specified. Ready to proceed to task generation and implementation.